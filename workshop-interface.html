<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pitch Workshop - PitchPerfect AI</title>
    <script src="pitchperfect-connector.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-guard.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* PRIMARY: Purple gradient (matches diagnostic) */
            --primary: #667eea;
            --primary-dark: #764ba2;
            --primary-light: #818cf8;

            /* ACCENT: Keep orange for special highlights */
            --accent: #D97706;
            --accent-dark: #B45309;

            /* NEUTRALS */
            --secondary: #065F46;
            --text-dark: #1F2937;
            --text-medium: #4B5563;
            --text-light: #6B7280;
            --bg-cream: #F8F7FF;
            /* Changed to light purple */
            --bg-light: #F9FAFB;
            --white: #FFFFFF;
            --error: #DC2626;
            --success: #059669;
            --border: #E5E7EB;

            /* GRADIENTS */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #D97706, #B45309);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-light);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-dark);
            position: fixed;
            width: 100%;
        }

        .container {
            display: flex;
            height: 100vh;
            height: 100dvh;
            position: relative;
        }

        .sidebar {
            width: 320px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #ffffff 0%, #fafbff 100%);
        }

        /* ========================================
           PROGRESS BAR IN SIDEBAR
           ======================================== */

        .sidebar-progress {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, #f8f7ff 0%, #ffffff 100%);
            border-radius: 12px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .progress-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            animation: numberPulse 0.5s ease;
        }

        @keyframes numberPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-stat {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8125rem;
            color: var(--text-medium);
            font-weight: 500;
        }

        .progress-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
        }

        .logo {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .logo:hover {
            transform: translateX(2px);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            /* Changed from orange */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: linear-gradient(180deg, #fafbff 0%, #ffffff 100%);
        }

        /* Custom scrollbar for sidebar */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.2);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.4);
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .phase-number {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #f8f7ff 0%, #ffffff 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--primary);
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            transition: all 0.3s ease;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .phase-card:hover .phase-number {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        .phase-card.completed .phase-number {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .phase-card.locked .phase-number {
            background: var(--bg-light);
            color: var(--text-light);
            border-color: transparent;
            box-shadow: none;
        }

        .phase-title {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-dark);
            flex: 1;
            line-height: 1.3;
            transition: color 0.2s ease;
        }

        .phase-card:hover .phase-title {
            color: var(--primary);
        }

        .phase-card.locked .phase-title {
            color: var(--text-light);
        }

        .phase-description {
            font-size: 0.8125rem;
            color: var(--text-medium);
            line-height: 1.5;
            margin-left: 2.75rem;
            transition: color 0.2s ease;
        }

        .phase-card.locked .phase-description {
            color: var(--text-light);
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--white);
            position: relative;
            min-width: 0;
        }

        .chat-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, #ffffff 0%, #fafbff 100%);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        }

        .chat-header-content {
            flex: 1;
        }

        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .restart-phase-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
        }

        .restart-phase-btn:hover {
            background: var(--border);
            border-color: var(--text-medium);
        }

        .restart-phase-btn.visible {
            display: block;
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--gradient-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .chat-subtitle {
            font-size: 0.875rem;
            color: var(--text-medium);
            line-height: 1.4;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 100%;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .message.assistant .message-avatar {
            background: var(--gradient-primary);
            color: white;
        }

        .message:hover .message-avatar {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #f8f7ff 0%, #e8e7ff 100%);
            color: var(--primary);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .message-content {
            flex: 1;
            max-width: 70%;
            min-width: 0;
        }

        .message.user .message-content {
            text-align: right;
        }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 16px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .message.assistant .message-bubble {
            background: var(--white);
            color: var(--text-dark);
            border: 1px solid var(--border);
            border-radius: 16px 16px 16px 4px;
        }

        .message:hover.assistant .message-bubble {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: rgba(102, 126, 234, 0.2);
        }

        .message.user .message-bubble {
            background: var(--gradient-primary);
            color: white;
            margin-left: auto;
            border-radius: 16px 16px 4px 16px;
        }

        .message:hover.user .message-bubble {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
            align-items: center;
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            background: var(--gradient-primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {

            0%,
            60%,
            100% {
                transform: translateY(0) scale(1);
            }

            30% {
                transform: translateY(-12px) scale(1.1);
            }
        }

        .chat-input-container {
            padding: 1.25rem 1.5rem;
            padding-bottom: max(1.25rem, env(safe-area-inset-bottom));
            border-top: 1px solid var(--border);
            background: var(--white);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.02);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 52px;
            max-height: 120px;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--border);
            border-radius: 14px;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            transition: all 0.2s ease;
            background: var(--white);
            line-height: 1.5;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: var(--bg-cream);
        }

        .chat-input::placeholder {
            color: var(--text-light);
        }

        .send-button {
            padding: 0.875rem 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .send-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .send-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            text-align: center;
            height: 100%;
            background: linear-gradient(135deg, #f8f7ff 0%, #ffffff 100%);
            position: relative;
            overflow: hidden;
        }

        .welcome-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        .welcome-icon {
            width: 96px;
            height: 96px;
            background: var(--gradient-primary);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.25);
            animation: welcomeIconFloat 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        @keyframes welcomeIconFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .welcome-screen h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-dark);
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }

        .welcome-screen p {
            font-size: 1.125rem;
            color: var(--text-medium);
            margin-bottom: 2.5rem;
            max-width: 640px;
            line-height: 1.7;
            position: relative;
            z-index: 1;
        }

        .start-button {
            padding: 1.125rem 3rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .start-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .start-button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 28px rgba(102, 126, 234, 0.4);
        }

        .start-button:hover::before {
            left: 100%;
        }

        .start-button:active {
            transform: translateY(-1px) scale(1);
        }


        .welcome-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 100px;
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .welcome-badge::before {
            content: 'âœ“';
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
        }


        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
            animation: modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-icon {
            width: 72px;
            height: 72px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.3);
            animation: iconPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.2s backwards;
        }

        @keyframes iconPop {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        .modal-icon.warning {
            background: var(--gradient-primary);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .modal h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .modal p {
            font-size: 1rem;
            color: var(--text-medium);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-button {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-button.primary {
            background: var(--gradient-primary);
            color: white;
        }

        .modal-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .modal-button.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .modal-button.danger {
            background: var(--error);
            color: white;
        }

        .modal-button.danger:hover {
            background: #B91C1C;
        }

        /* ========================================
           CONFETTI CELEBRATION
           ======================================== */

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary);
            animation: confettiFall 3s linear forwards;
            z-index: 9999;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .milestone-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 2rem 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            text-align: center;
            animation: milestonePopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes milestonePopIn {
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .milestone-message h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .milestone-message p {
            font-size: 1.125rem;
            color: var(--text-medium);
            margin: 0;
        }

        /* ========================================
   MENU TOGGLE (MOBILE)
   ======================================== */

        .menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            background: var(--primary);
            /* Purple */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .menu-toggle:hover {
            background: var(--primary-dark);
        }

        /* ========================================
   METRICS DASHBOARD STYLES
   ======================================== */

        /* Metrics Toggle Button - HIDDEN BY DEFAULT */
        .metrics-toggle-btn {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #6366F1, #4F46E5);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
        }

        .metrics-toggle-btn.visible {
            display: flex;
        }

        .metrics-toggle-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
        }

        /* Metrics Overlay */
        .metrics-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }

        .metrics-overlay.active {
            display: flex;
        }

        /* Metrics Panel */
        .metrics-panel {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metrics-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metrics-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .metrics-close {
            width: 32px;
            height: 32px;
            background: var(--bg-light);
            border: none;
            border-radius: 8px;
            font-size: 1.25rem;
            color: var(--text-medium);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .metrics-close:hover {
            background: var(--error);
            color: white;
        }

        .metrics-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .metrics-loading {
            text-align: center;
            color: var(--text-medium);
            padding: 2rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.25rem;
            border: 2px solid var(--border);
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-medium);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
        }

        .metric-value.success {
            color: var(--success);
        }

        .metric-value.warning {
            color: var(--primary);
        }

        .metric-subtext {
            font-size: 0.8125rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        /* Phase Breakdown */
        .phase-metrics {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .phase-metrics-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .phase-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .phase-metric-row:last-child {
            margin-bottom: 0;
        }

        .phase-metric-label {
            font-size: 0.875rem;
            color: var(--text-medium);
            font-weight: 600;
        }

        .phase-metric-value {
            font-size: 0.875rem;
            color: var(--text-dark);
            font-weight: 700;
        }

        /* Action Buttons */
        .metrics-actions {
            display: flex;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .metrics-action-btn {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .metrics-action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .metrics-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4);
        }

        .metrics-action-btn.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .metrics-action-btn.secondary:hover {
            background: var(--border);
        }

        .metrics-action-btn.danger {
            background: var(--error);
            color: white;
        }

        .metrics-action-btn.danger:hover {
            background: #B91C1C;
            transform: translateY(-2px);
        }

        /* ========================================
           CRITICAL: Prevent display conflicts
           ======================================== */

        .chat-messages[style*="display: flex"] {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .chat-input-container[style*="display: block"] {
            display: block !important;
            visibility: visible !important;
        }

        .welcome-screen[style*="display: none"] {
            display: none !important;
        }

        .welcome-screen[style*="display: flex"] {
            display: flex !important;
        }

        /* ========================================
   MOBILE RESPONSIVE
   ======================================== */

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -320px;
                top: 0;
                height: 100vh;
                height: 100dvh;
                z-index: 100;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.open {
                left: 0;
            }

            .main-area {
                width: 100%;
            }

            .chat-header {
                padding: 1rem;
                flex-wrap: wrap;
            }

            .chat-header-actions {
                width: 100%;
                margin-top: 0.5rem;
            }

            .restart-phase-btn {
                padding: 0.625rem 1.125rem;
                background: var(--white);
                color: var(--text-dark);
                border: 2px solid var(--border);
                border-radius: 10px;
                font-size: 0.875rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                display: none;
            }

            .restart-phase-btn:hover {
                background: var(--bg-cream);
                border-color: var(--primary);
                color: var(--primary);
                transform: translateY(-1px);
            }

            .restart-phase-btn.visible {
                display: block;
            }

            .chat-title {
                font-size: 1rem;
            }

            .chat-subtitle {
                font-size: 0.8125rem;
            }

            .chat-messages {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 2rem 1.5rem;
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                -webkit-overflow-scrolling: touch;
                background: linear-gradient(180deg, #fafbff 0%, #ffffff 100%);
            }

            /* Custom scrollbar for chat */
            .chat-messages::-webkit-scrollbar {
                width: 8px;
            }

            .chat-messages::-webkit-scrollbar-track {
                background: transparent;
            }

            .chat-messages::-webkit-scrollbar-thumb {
                background: rgba(102, 126, 234, 0.2);
                border-radius: 4px;
            }

            .chat-messages::-webkit-scrollbar-thumb:hover {
                background: rgba(102, 126, 234, 0.4);
            }

            .message-content {
                max-width: 85%;
            }

            .message-bubble {
                padding: 0.875rem 1rem;
                font-size: 0.9375rem;
            }

            .chat-input-container {
                padding: 0.875rem 1rem;
                padding-bottom: max(0.875rem, env(safe-area-inset-bottom));
            }

            .chat-input {
                font-size: 16px;
                min-height: 44px;
            }

            .send-button {
                padding: 0.75rem 1rem;
                font-size: 0.9375rem;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .welcome-screen {
                padding: 1.5rem;
            }

            .welcome-icon {
                width: 80px;
                height: 80px;
                background: var(--gradient-primary);
                /* Purple gradient */
                border-radius: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2.5rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            }

            .welcome-screen h2 {
                font-size: 1.5rem;
            }

            .welcome-screen p {
                font-size: 0.9375rem;
            }

            .start-button {
                padding: 0.875rem 2rem;
                font-size: 1rem;
                width: 100%;
            }

            .modal {
                padding: 1.5rem;
            }

            .modal h3 {
                font-size: 1.25rem;
            }

            /* Metrics Mobile */
            .metrics-toggle-btn {
                bottom: 16px;
                left: 16px;
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }

            .metrics-panel {
                max-width: 100%;
                max-height: 95vh;
                margin: 0.5rem;
            }

            .metrics-header {
                padding: 1rem;
            }

            .metrics-header h3 {
                font-size: 1.125rem;
            }

            .metrics-content {
                padding: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 1.75rem;
            }

            .metrics-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .chat-messages {
                padding: 0.75rem;
            }

            .chat-input-container {
                padding: 0.5rem 1rem;
            }

            .chat-input {
                min-height: 40px;
                max-height: 60px;
            }
        }

        /* ========================================
   TIER BADGES & VISUAL ENHANCEMENTS
   ======================================== */

        .tier-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 0.5rem;
            vertical-align: middle;
            white-space: nowrap;
        }

        .tier-badge.core {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .tier-badge.professional {
            background: linear-gradient(135deg, #D97706, #B45309);
            color: white;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
        }

        .phase-card.locked .tier-badge {
            opacity: 0.95;
        }

        .phase-estimated-time {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-left: 2.75rem;
            margin-top: 0.25rem;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .phase-lock-icon {
            font-size: 0.875rem;
            opacity: 0.7;
        }

        /* Enhanced locked phase styling */
        .phase-card.locked {
            opacity: 0.75;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .phase-card.locked:hover {
            opacity: 0.9;
            background: #F9FAFB;
            transform: translateX(4px);
        }

        .phase-card.locked .phase-title {
            color: #6B7280;
        }

        /* ========================================
   EVALUATION RESULTS DISPLAY
   ======================================== */

        .evaluation-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--border);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .score-display {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .score-circle-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 3rem;
            font-weight: 700;
            position: relative;
        }

        .score-circle-large.excellent {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.3);
        }

        .score-circle-large.good {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .score-circle-large.needs-work {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            box-shadow: 0 8px 24px rgba(217, 119, 6, 0.3);
        }

        .score-label {
            font-size: 1rem;
            color: var(--text-medium);
            font-weight: 600;
        }

        .criteria-section {
            margin-bottom: 1.5rem;
        }

        .criteria-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-medium);
            margin-bottom: 0.75rem;
        }

        .criterion-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-light);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .criterion-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .criterion-icon.met {
            background: var(--success);
            color: white;
        }

        .criterion-icon.missing {
            background: var(--error);
            color: white;
        }

        .criterion-text {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-dark);
        }

        .feedback-box {
            background: #FFFBEB;
            border-left: 4px solid #F59E0B;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .feedback-box strong {
            color: #D97706;
            font-size: 0.875rem;
        }

        .feedback-box p {
            margin: 0.5rem 0 0 0;
            font-size: 0.875rem;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .gaps-list {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0 0 0;
        }

        .gaps-list li {
            padding: 0.5rem 0;
            font-size: 0.875rem;
            color: var(--text-medium);
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .gaps-list li::before {
            content: 'â†’';
            color: #F59E0B;
            font-weight: 700;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .action-button {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button.primary {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .action-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
        }

        .action-button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-button.secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 2px solid var(--border);
        }

        .action-button.secondary:hover {
            background: var(--border);
        }
    </style>
</head>

<body>
    <div class="container"> <!-- âœ… ADD THIS LINE -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">PP</div>
                    PitchPerfect AI
                </a>

                <div class="sidebar-progress" id="sidebarProgress">
                    <div class="progress-header">
                        <span class="progress-label">Dein Fortschritt</span>
                        <span class="progress-percentage" id="progressPercentage">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progressBarFill"></div>
                    </div>
                    <div class="progress-stats">
                        <span class="progress-stat">
                            <span class="progress-icon">âœ“</span>
                            <span id="completedCount">0</span> von 12 Phasen
                        </span>
                    </div>
                </div>
            </div>

            <div class="sidebar-content" id="phasesList">
            </div>
        </div>

        <div class="main-area">
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-content">
                    <div class="chat-title">WÃ¤hle eine Phase zum Starten</div>
                    <div class="chat-subtitle">Systematische Pitch-Verfeinerung in 12 Phasen</div>
                </div>
                <div class="chat-header-actions">
                    <button class="restart-phase-btn" id="restartPhaseBtn" onclick="confirmRestartPhase()">
                        ðŸ”„ Phase neu starten
                    </button>
                    <button class="menu-toggle" id="menuToggle" onclick="toggleSidebar()" style="display: none;">
                        â˜°
                    </button>
                </div>
            </div>

            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-badge">Diagnose abgeschlossen</div>
                <div class="welcome-icon">ðŸ’ª</div>
                <h2>Willkommen im Pitch-Workshop</h2>
                <p>
                    Du bist dabei, deinen Pitch durch 12 systematische Verfeinerungs-Phasen zu bringen.
                    Jede Phase fokussiert auf ein kritisches Element und verwendet Expertenbefragung,
                    um deine Geschichte zu stÃ¤rken.
                </p>
                <button class="start-button" onclick="selectPhase(2)">Phase 2 starten: Fatale Fehler beheben</button>
            </div>

            <div class="chat-messages" id="chatMessages" style="display: none;">
            </div>

            <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                <!-- âœ… NEW: Check Readiness Section -->
                <div id="readinessSection" style="
                    padding: 1rem 1.5rem;
                    background: linear-gradient(135deg, #f8f7ff 0%, #ffffff 100%);
                    border-bottom: 1px solid var(--border);
                    display: none;
                ">
                    <button id="checkReadinessBtn" onclick="checkPhaseReadiness()" style="
                            width: 100%;
                            padding: 0.875rem 1.5rem;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                        "
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                        ðŸŽ¯ Check Readiness - Bin ich bereit?
                    </button>

                    <!-- Evaluation Results Display -->
                    <div id="evaluationResults" style="display: none; margin-top: 1rem;">
                        <!-- Results will be inserted here -->
                    </div>
                </div>

                <!-- Existing chat input -->
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="chatInput" placeholder="Schreibe deine Antwort..."
                        rows="1"></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        Senden
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase Completion Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-icon">âœ“</div>
            <h3>Phase abgeschlossen!</h3>
            <p id="modalMessage">GroÃŸartige Arbeit! Du hast diesen kritischen Bereich gestÃ¤rkt.</p>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="nextPhase()">NÃ¤chste Phase â†’</button>
                <button class="modal-button secondary" onclick="closeModal()">Weiter bearbeiten</button>
            </div>
        </div>
    </div>

    <!-- Restart Phase Confirmation Modal -->
    <div class="modal-overlay" id="restartModal">
        <div class="modal">
            <div class="modal-icon warning">âš ï¸</div>
            <h3>Phase neu starten?</h3>
            <p>MÃ¶chtest du diese Phase wirklich neu starten? Alle bisherigen Nachrichten werden gelÃ¶scht und du beginnst
                von vorne.</p>
            <div class="modal-buttons">
                <button class="modal-button danger" onclick="restartPhase()">Ja, neu starten</button>
                <button class="modal-button secondary" onclick="closeRestartModal()">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- METRICS DASHBOARD -->
    <div id="metricsOverlay" class="metrics-overlay">
        <div class="metrics-panel">
            <div class="metrics-header">
                <h3>ðŸ“Š API Metrics Dashboard</h3>
                <button class="metrics-close" onclick="toggleMetrics()">âœ•</button>
            </div>
            <div class="metrics-content" id="metricsContent">
                <div class="metrics-loading">Loading metrics...</div>
            </div>
        </div>
    </div>

    <button id="metricsToggleBtn" class="metrics-toggle-btn" onclick="toggleMetrics()"
        title="Metrics Dashboard (Ctrl+Shift+M)">
        ðŸ“Š
    </button>

    <script>
        const PHASES = [
            {
                number: 2,
                title: "Fatale Fehler Diagnose",
                description: "Behebe kritische LÃ¼cken aus deiner Diagnose",
                tier: "free",  // âœ… Added
                estimatedTime: "20-30 min",  // âœ… Added
                unlocked: true
            },
            {
                number: 3,
                title: "Problem-Befragung",
                description: "Mache deine Problemstellung kristallklar",
                tier: "free",  // âœ… Added
                estimatedTime: "25-35 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 4,
                title: "LÃ¶sungsklarheit",
                description: "Stelle sicher, dass deine LÃ¶sung einleuchtend ist",
                tier: "free",  // âœ… Added
                estimatedTime: "20-30 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 5,
                title: "Marktchance",
                description: "Validiere und quantifiziere deine MarktgrÃ¶ÃŸe",
                tier: "core",  // âœ… Added - CORE STARTS HERE
                estimatedTime: "30-40 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 6,
                title: "GeschÃ¤ftsmodell & Ã–konomie",
                description: "Beweise, dass die Unit Economics funktionieren",
                tier: "core",  // âœ… Added
                estimatedTime: "35-45 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 7,
                title: "Traktion & Validierung",
                description: "Zeige Beweise, dass Leute das wollen",
                tier: "core",  // âœ… Added
                estimatedTime: "30-40 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 8,
                title: "Team-GlaubwÃ¼rdigkeit",
                description: "Baue eine Ã¼berzeugende GrÃ¼nder-Story",
                tier: "core",  // âœ… Added
                estimatedTime: "25-35 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 9,
                title: "Wettbewerbslandschaft",
                description: "Definiere deinen unfairen Vorteil",
                tier: "professional",  // âœ… Added - PROFESSIONAL STARTS HERE
                estimatedTime: "35-45 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 10,
                title: "Die Anfrage & Mittel",
                description: "Artikuliere deinen Kapitalbedarf klar",
                tier: "professional",  // âœ… Added
                estimatedTime: "30-40 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 11,
                title: "Narrativer Fluss",
                description: "Optimiere deine Story-Architektur",
                tier: "professional",  // âœ… Added
                estimatedTime: "40-50 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 12,
                title: "Q&A Vorbereitung",
                description: "Bereite auf harte Investorenfragen vor",
                tier: "professional",  // âœ… Added
                estimatedTime: "35-45 min",  // âœ… Added
                unlocked: false
            },
            {
                number: 13,
                title: "Finale ÃœberprÃ¼fung",
                description: "Umfassende Pitch-Bewertung & Export",
                tier: "professional",  // âœ… Added
                estimatedTime: "25-35 min",  // âœ… Added
                unlocked: false
            }
        ];

        // ========================================
        // FEATURE FLAGS & TIER CONFIGURATION
        // ========================================

        const TIER_ACCESS = {
            free: {
                allowedPhases: [2, 3, 4],  // âœ… FREE: First 3 phases (Fatal Errors, Problem, Solution)
                displayName: "Free",
                features: {
                    diagnosticAccess: true,
                    workshopPhases: 3,
                    projectLimit: 1,
                    exportPDF: false,
                    aiFeedback: false
                }
            },
            core: {
                allowedPhases: [2, 3, 4, 5, 6, 7, 8],  // âœ… CORE: 7 phases (adds Market, Traction, Model, Team)
                displayName: "Core",
                features: {
                    diagnosticAccess: true,
                    workshopPhases: 7,  // âœ… Fixed from 12 to 7
                    projectLimit: 10,
                    exportPDF: true,
                    aiFeedback: true
                }
            },
            professional: {
                allowedPhases: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13],  // âœ… PRO: All 12 phases
                displayName: "Professional",
                features: {
                    diagnosticAccess: true,
                    workshopPhases: 12,
                    projectLimit: Infinity,
                    exportPDF: true,
                    aiFeedback: true,
                    prioritySupport: true,
                    customBranding: true,
                    advancedPhases: true,  // âœ… Added feature flag
                    collaboration: true     // âœ… Added feature flag
                }
            }
        };

        function canAccessPhase(userTier, phaseNumber) {
            const tierConfig = TIER_ACCESS[userTier] || TIER_ACCESS.free;
            return tierConfig.allowedPhases.includes(phaseNumber);
        }

        function getCompletedPhasesCount() {
            return Object.keys(state.phaseCompletion).filter(key => state.phaseCompletion[key] === true).length;
        }

        function calculateProgress() {
            const completed = getCompletedPhasesCount();
            const total = PHASES.length;
            return Math.round((completed / total) * 100);
        }

        // Make state globally accessible for debugging
        window.state = {
            currentPhase: null,
            messages: [],
            isTyping: false,
            phaseCompletion: {},
            phaseScores: {}
        };

        // Use window.state everywhere instead of just state
        let state = window.state;

        // ========================================
        // METRICS SYSTEM
        // ========================================

        const MetricsSystem = {
            data: {
                totalCost: 0,
                totalRequests: 0,
                cacheHits: 0,
                cacheMisses: 0,
                totalLatency: 0,
                totalInputTokens: 0,
                totalOutputTokens: 0,
                phaseMetrics: {},
                sessionStart: Date.now()
            },

            init() {
                // Load saved metrics from sessionStorage
                const saved = sessionStorage.getItem('pitchperfect_metrics');
                if (saved) {
                    try {
                        this.data = JSON.parse(saved);
                    } catch (e) {
                        console.error('Failed to parse saved metrics:', e);
                    }
                }

                // Listen for metrics updates from PitchPerfect connector
                window.addEventListener('pitchperfect:metrics', (event) => {
                    this.update(event.detail);
                });

                // Check for admin mode via URL parameter or localStorage
                this.checkAdminMode();

                console.log('ðŸ“Š Metrics System Initialized');
            },

            checkAdminMode() {
                const urlParams = new URLSearchParams(window.location.search);
                const adminParam = urlParams.get('admin');
                const adminStored = localStorage.getItem('pitchperfect_admin');

                if (adminParam === 'true') {
                    localStorage.setItem('pitchperfect_admin', 'true');
                    this.enableMetrics();
                } else if (adminParam === 'false') {
                    localStorage.removeItem('pitchperfect_admin');
                    this.disableMetrics();
                } else if (adminStored === 'true') {
                    this.enableMetrics();
                }
            },

            enableMetrics() {
                document.getElementById('metricsToggleBtn').classList.add('visible');
                console.log('ðŸ“Š Metrics Dashboard Enabled (Admin Mode)');
            },

            disableMetrics() {
                document.getElementById('metricsToggleBtn').classList.remove('visible');
                document.getElementById('metricsOverlay').classList.remove('active');
            },

            update(metrics) {
                console.log('ðŸ“Š Metrics Update:', metrics);

                this.data.totalCost += metrics.cost || 0;
                this.data.totalRequests += 1;

                if (metrics.cacheHit) {
                    this.data.cacheHits += 1;
                } else {
                    this.data.cacheMisses += 1;
                }

                this.data.totalLatency += metrics.latency || 0;
                this.data.totalInputTokens += metrics.inputTokens || 0;
                this.data.totalOutputTokens += metrics.outputTokens || 0;

                // Track per-phase metrics
                const phase = metrics.phase || state.currentPhase || 'unknown';
                if (!this.data.phaseMetrics[phase]) {
                    this.data.phaseMetrics[phase] = {
                        requests: 0,
                        cost: 0,
                        latency: 0
                    };
                }

                this.data.phaseMetrics[phase].requests += 1;
                this.data.phaseMetrics[phase].cost += metrics.cost || 0;
                this.data.phaseMetrics[phase].latency += metrics.latency || 0;

                // Save to sessionStorage
                sessionStorage.setItem('pitchperfect_metrics', JSON.stringify(this.data));

                // Update display if metrics panel is open
                if (document.getElementById('metricsOverlay').classList.contains('active')) {
                    this.render();
                }
            },

            render() {
                const content = document.getElementById('metricsContent');
                const cacheHitRate = this.data.totalRequests > 0
                    ? ((this.data.cacheHits / this.data.totalRequests) * 100).toFixed(1)
                    : 0;

                const avgLatency = this.data.totalRequests > 0
                    ? (this.data.totalLatency / this.data.totalRequests / 1000).toFixed(2)
                    : 0;

                const sessionDuration = Math.floor((Date.now() - this.data.sessionStart) / 1000 / 60);

                content.innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Cost</div>
                            <div class="metric-value warning">$${this.data.totalCost.toFixed(4)}</div>
                            <div class="metric-subtext">${this.data.totalRequests} requests</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-label">Cache Hit Rate</div>
                            <div class="metric-value success">${cacheHitRate}%</div>
                            <div class="metric-subtext">${this.data.cacheHits} hits / ${this.data.cacheMisses} misses</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-label">Avg Latency</div>
                            <div class="metric-value">${avgLatency}s</div>
                            <div class="metric-subtext">Per request</div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-label">Total Tokens</div>
                            <div class="metric-value">${(this.data.totalInputTokens + this.data.totalOutputTokens).toLocaleString()}</div>
                            <div class="metric-subtext">${this.data.totalInputTokens.toLocaleString()} in / ${this.data.totalOutputTokens.toLocaleString()} out</div>
                        </div>
                    </div>

                    ${this.renderPhaseBreakdown()}

                    <div class="metrics-actions">
                        <button class="metrics-action-btn secondary" onclick="MetricsSystem.exportMetrics()">
                            ðŸ“¥ Export CSV
                        </button>
                        <button class="metrics-action-btn danger" onclick="MetricsSystem.reset()">
                            ðŸ—‘ï¸ Reset Metrics
                        </button>
                    </div>
                `;
            },

            renderPhaseBreakdown() {
                const phases = Object.keys(this.data.phaseMetrics).sort((a, b) => {
                    const aNum = parseInt(a);
                    const bNum = parseInt(b);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return aNum - bNum;
                    }
                    return a.localeCompare(b);
                });

                if (phases.length === 0) {
                    return '';
                }

                let html = '<div class="phase-metrics"><div class="phase-metrics-title">ðŸ“ˆ Phase Breakdown</div>';

                phases.forEach(phase => {
                    const metrics = this.data.phaseMetrics[phase];
                    const avgLatency = (metrics.latency / metrics.requests / 1000).toFixed(2);
                    html += `
                        <div class="phase-metric-row">
                            <div class="phase-metric-label">Phase ${phase}</div>
                            <div class="phase-metric-value">
                                ${metrics.requests} req â€¢ $${metrics.cost.toFixed(4)} â€¢ ${avgLatency}s avg
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                return html;
            },

            reset() {
                if (confirm('âš ï¸ Are you sure you want to reset all metrics? This cannot be undone.')) {
                    this.data = {
                        totalCost: 0,
                        totalRequests: 0,
                        cacheHits: 0,
                        cacheMisses: 0,
                        totalLatency: 0,
                        totalInputTokens: 0,
                        totalOutputTokens: 0,
                        phaseMetrics: {},
                        sessionStart: Date.now()
                    };
                    sessionStorage.removeItem('pitchperfect_metrics');
                    this.render();
                }
            },

            exportMetrics() {
                const csv = this.generateCSV();
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pitchperfect-metrics-${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            },

            generateCSV() {
                let csv = 'Phase,Requests,Cost (USD),Avg Latency (s)\n';

                Object.keys(this.data.phaseMetrics).sort((a, b) => {
                    const aNum = parseInt(a);
                    const bNum = parseInt(b);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return aNum - bNum;
                    }
                    return a.localeCompare(b);
                }).forEach(phase => {
                    const metrics = this.data.phaseMetrics[phase];
                    const avgLatency = (metrics.latency / metrics.requests / 1000).toFixed(2);
                    csv += `${phase},${metrics.requests},${metrics.cost.toFixed(4)},${avgLatency}\n`;
                });

                csv += `\nSummary\n`;
                csv += `Total Cost,$${this.data.totalCost.toFixed(4)}\n`;
                csv += `Total Requests,${this.data.totalRequests}\n`;
                csv += `Cache Hit Rate,${((this.data.cacheHits / this.data.totalRequests) * 100).toFixed(1)}%\n`;
                csv += `Total Tokens,${this.data.totalInputTokens + this.data.totalOutputTokens}\n`;
                csv += `Input Tokens,${this.data.totalInputTokens}\n`;
                csv += `Output Tokens,${this.data.totalOutputTokens}\n`;

                return csv;
            }
        };

        // Toggle metrics dashboard
        function toggleMetrics() {
            const overlay = document.getElementById('metricsOverlay');
            overlay.classList.toggle('active');

            if (overlay.classList.contains('active')) {
                MetricsSystem.render();
            }
        }

        // ========================================
        // PHASE RESTART FUNCTIONALITY
        // ========================================

        function confirmRestartPhase() {
            document.getElementById('restartModal').classList.add('active');
        }

        function closeRestartModal() {
            document.getElementById('restartModal').classList.remove('active');
        }

        function restartPhase() {
            if (!state.currentPhase) return;

            // Clear messages for this phase
            state.messages = [];

            // Clear from localStorage
            const demoState = PitchPerfect.DemoState.load();
            if (demoState.workshop.messages && demoState.workshop.messages[state.currentPhase]) {
                delete demoState.workshop.messages[state.currentPhase];
                PitchPerfect.DemoState.save(demoState);

                console.log('ðŸ” About to call showReadinessButton()');
                showReadinessButton();

                console.log('âœ… === selectPhase END ===');
            }

            // Close modal
            closeRestartModal();

            // Reload the phase with welcome message
            loadPhaseMessages(state.currentPhase);
        }

        // ========================================
        // AUTHENTICATION & USER STATE
        // ========================================

        let currentUser = null;
        let userProfile = null;
        let currentProject = null;

        async function initWorkshopAuth() {
            console.log('ðŸ” Initializing workshop authentication...');

            // Check authentication
            const authData = await getCurrentUserWithProfile();
            if (!authData) {
                console.log('âŒ Not authenticated, redirecting to login');
                return false;
            }

            currentUser = authData.user;
            userProfile = authData.profile;

            console.log('âœ… User authenticated:', {
                email: currentUser.email,
                tier: userProfile.tier,
                name: userProfile.full_name
            });

            // Load their project data
            await loadProjectData();

            return true;
        }

        async function loadProjectData() {
            try {
                console.log('ðŸ“‚ Loading project data...');

                const { data: projects, error } = await supabaseClient
                    .from('pitch_projects')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('Error loading project:', error);
                    return;
                }

                if (projects && projects.length > 0) {
                    currentProject = projects[0];
                    console.log('âœ… Project loaded:', currentProject.title);

                    // Apply diagnostic data if exists
                    if (currentProject.diagnostic_data) {
                        applyDiagnosticData(currentProject.diagnostic_data);
                    }
                } else {
                    console.log('â„¹ï¸ No project found - user should complete diagnostic first');
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }

        // ========================================
        // SMART UPGRADE PROMPT
        // ========================================

        function showUpgradePrompt(attemptedPhase) {
            const completedCount = getCompletedPhasesCount();
            const progress = calculateProgress();
            const userTier = userProfile?.tier || 'free';

            // Get what they've completed
            const completedPhases = Object.keys(state.phaseCompletion)
                .filter(key => state.phaseCompletion[key] === true)
                .map(key => PHASES.find(p => p.number === parseInt(key)))
                .filter(p => p);

            // Build list of completed achievements
            let achievementsList = '';
            if (completedPhases.length > 0) {
                achievementsList = completedPhases.map(phase =>
                    `<div style="
                padding: 12px;
                background: #D1FAE5;
                border-radius: 8px;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 12px;
            ">
                <div style="
                    width: 24px;
                    height: 24px;
                    background: #059669;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 14px;
                    font-weight: 700;
                    flex-shrink: 0;
                ">âœ“</div>
                <div style="flex: 1;">
                    <strong style="color: #1F2937;">Phase ${phase.number}:</strong>
                    <span style="color: #4B5563;"> ${phase.title}</span>
                </div>
            </div>`
                ).join('');
            }

            // Different messages based on tier and attempted phase
            let upgradeMessage = {
                title: '',
                subtitle: '',
                nextPhases: [],
                price: '',
                period: '',
                valueProps: [],
                targetTier: ''
            };

            // FREE â†’ CORE upgrade (attempting phases 5-8)
            if (userTier === 'free' && attemptedPhase >= 5 && attemptedPhase <= 8) {
                upgradeMessage = {
                    title: 'ðŸŽ‰ GroÃŸartige Arbeit! Du hast die Basis geschaffen.',
                    subtitle: `Du bist bereits ${Math.round(progress)}% durch deinen Pitch!`,
                    nextPhases: [
                        '<strong>Phase 5:</strong> Marktchance - Validiere deine MarktgrÃ¶ÃŸe',
                        '<strong>Phase 6:</strong> GeschÃ¤ftsmodell - Unit Economics zeigen',
                        '<strong>Phase 7:</strong> Traktion - Beweise mit echten Zahlen',
                        '<strong>Phase 8:</strong> Team - Baue GlaubwÃ¼rdigkeit auf'
                    ],
                    price: 'â‚¬29',
                    period: '/Monat',
                    valueProps: [
                        'ðŸ’° Weniger als 1 BNI-FrÃ¼hstÃ¼ck pro Monat',
                        'â±ï¸ Spart 10+ Stunden Pitch-Arbeit',
                        'ðŸ“Š Export als professionelles Script',
                        'âœ… VollstÃ¤ndiger investor-ready Pitch'
                    ],
                    targetTier: 'core'
                };
            }

            // CORE â†’ PROFESSIONAL upgrade (attempting phases 9-13)
            else if (userTier === 'core' && attemptedPhase >= 9) {
                upgradeMessage = {
                    title: 'ðŸš€ Du bist fast investor-ready!',
                    subtitle: 'Top-Investoren erwarten diese fortgeschrittenen Elemente:',
                    nextPhases: [
                        '<strong>Phase 9:</strong> Wettbewerbslandschaft - Unfairer Vorteil',
                        '<strong>Phase 10:</strong> Die Anfrage - Kapitalbedarf artikulieren',
                        '<strong>Phase 11:</strong> Narrativer Fluss - Story optimieren',
                        '<strong>Phase 12:</strong> Q&A Vorbereitung - Harte Fragen meistern',
                        '<strong>Phase 13:</strong> Finale ÃœberprÃ¼fung - Export & Polish'
                    ],
                    price: 'â‚¬79',
                    period: '/Monat',
                    valueProps: [
                        'ðŸ“ˆ 80% gÃ¼nstiger als Coaching (â‚¬1.000-2.500)',
                        'ðŸŽ¯ Unit Economics Deep-Dive (CAC, LTV)',
                        'âš¡ Competitive Intelligence Analyse',
                        'ðŸ”¥ Q&A Prep fÃ¼r kritische Investorenfragen',
                        'ðŸ’Ž Professional Export (Script + Outline + Slides)'
                    ],
                    targetTier: 'professional'
                };
            }

            // Fallback for any other case
            else {
                upgradeMessage = {
                    title: 'ðŸ”’ Diese Phase ist gesperrt',
                    subtitle: 'Upgrade fÃ¼r vollen Zugriff auf alle Workshop-Phasen',
                    nextPhases: ['Alle restlichen Phasen'],
                    price: 'â‚¬29',
                    period: '/Monat',
                    valueProps: ['VollstÃ¤ndiger Pitch-Workshop'],
                    targetTier: 'core'
                };
            }

            const mainArea = document.querySelector('.main-area');
            mainArea.innerHTML = `
        <div style="
            height: 100%;
            overflow-y: auto;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        ">
            <div style="
                max-width: 700px;
                margin: 0 auto;
                background: white;
                border-radius: 20px;
                padding: 48px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            ">
                <!-- Progress Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="
                        width: 80px;
                        height: 80px;
                        background: linear-gradient(135deg, #D97706, #B45309);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 40px;
                        margin: 0 auto 24px;
                        box-shadow: 0 8px 16px rgba(217, 119, 6, 0.3);
                    ">ðŸŽ¯</div>
                    <h2 style="
                        font-size: 28px;
                        font-weight: 700;
                        color: #1F2937;
                        margin-bottom: 12px;
                        line-height: 1.3;
                    ">${upgradeMessage.title}</h2>
                    <p style="
                        font-size: 16px;
                        color: #6B7280;
                    ">${upgradeMessage.subtitle}</p>
                </div>

                <!-- Progress Bar -->
                <div style="
                    width: 100%;
                    height: 12px;
                    background: #E5E7EB;
                    border-radius: 6px;
                    overflow: hidden;
                    margin-bottom: 40px;
                ">
                    <div style="
                        height: 100%;
                        background: linear-gradient(90deg, #059669, #10B981);
                        width: ${Math.round(progress)}%;
                        transition: width 0.5s ease;
                    "></div>
                </div>

                <!-- What You've Created -->
                ${completedPhases.length > 0 ? `
                    <div style="
                        background: #F9FAFB;
                        border-radius: 12px;
                        padding: 24px;
                        margin-bottom: 32px;
                    ">
                        <h3 style="
                            font-size: 18px;
                            font-weight: 700;
                            color: #1F2937;
                            margin-bottom: 16px;
                        ">âœ¨ Was du bereits erstellt hast:</h3>
                        ${achievementsList}
                    </div>
                ` : ''}

                <!-- What's Next -->
                <div style="
                    background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
                    border-left: 4px solid #D97706;
                    border-radius: 12px;
                    padding: 24px;
                    margin-bottom: 32px;
                ">
                    <h3 style="
                        font-size: 18px;
                        font-weight: 700;
                        color: #1F2937;
                        margin-bottom: 16px;
                    ">ðŸš€ Schalte die nÃ¤chsten Phasen frei:</h3>
                    <ul style="
                        margin: 0;
                        padding-left: 20px;
                        color: #4B5563;
                        line-height: 1.8;
                    ">
                        ${upgradeMessage.nextPhases.map(phase => `<li style="margin-bottom: 8px;">${phase}</li>`).join('')}
                    </ul>
                </div>

                <!-- Pricing -->
                <div style="
                    text-align: center;
                    padding: 24px;
                    background: #F9FAFB;
                    border-radius: 12px;
                    margin-bottom: 24px;
                ">
                    <div style="
                        font-size: 48px;
                        font-weight: 700;
                        color: #D97706;
                        margin-bottom: 8px;
                    ">${upgradeMessage.price}<span style="font-size: 20px; color: #6B7280;">${upgradeMessage.period}</span></div>
                    <p style="
                        font-size: 14px;
                        color: #6B7280;
                        margin: 0;
                    ">Jederzeit kÃ¼ndbar â€¢ 7 Tage Geld-zurÃ¼ck-Garantie</p>
                </div>

                <!-- Value Props -->
                <div style="
                    background: white;
                    border: 2px solid #E5E7EB;
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 32px;
                ">
                    ${upgradeMessage.valueProps.map((prop, index) => `
                        <div style="
                            padding: 12px 0;
                            ${index < upgradeMessage.valueProps.length - 1 ? 'border-bottom: 1px solid #F3F4F6;' : ''}
                            font-size: 15px;
                            color: #4B5563;
                        ">${prop}</div>
                    `).join('')}
                </div>

                <!-- CTA Buttons -->
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="window.location.href='/pricing.html'" style="
                        width: 100%;
                        padding: 18px;
                        background: linear-gradient(135deg, #D97706, #B45309);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 18px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(217, 119, 6, 0.5)'"
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(217, 119, 6, 0.4)'">
                        Jetzt auf ${upgradeMessage.targetTier === 'core' ? 'Core' : 'Professional'} upgraden â†’
                    </button>
                    
                    <button onclick="location.reload()" style="
                        width: 100%;
                        padding: 16px;
                        background: white;
                        color: #4B5563;
                        border: 2px solid #E5E7EB;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='#F9FAFB'; this.style.borderColor='#D1D5DB'"
                       onmouseout="this.style.background='white'; this.style.borderColor='#E5E7EB'">
                        ZurÃ¼ck zum Workshop
                    </button>
                </div>

                <!-- Social Proof -->
                <div style="
                    text-align: center;
                    margin-top: 32px;
                    padding-top: 32px;
                    border-top: 1px solid #E5E7EB;
                ">
                    <p style="
                        font-size: 13px;
                        color: #9CA3AF;
                        margin-bottom: 8px;
                    ">Bereits genutzt von</p>
                    <p style="
                        font-size: 24px;
                        font-weight: 700;
                        color: #1F2937;
                        margin: 0;
                    ">2,847+ GrÃ¼ndern</p>
                </div>
            </div>
        </div>
    `;
        }

        function upgradeNow() {
            trackEvent('upgrade_button_clicked', {
                source: 'workshop_paywall',
                completedPhases: getCompletedPhasesCount(),
                userTier: userProfile?.tier || 'free'
            });

            // Redirect to pricing page
            window.location.href = '/pricing.html';
        }

        function saveAndDecideLater() {
            trackEvent('save_and_decide_later', {
                completedPhases: getCompletedPhasesCount(),
                userTier: userProfile?.tier || 'free'
            });

            // Go back to dashboard
            window.location.href = '/dashboard.html';
        }

        function applyDiagnosticData(diagnosticData) {
            console.log('ðŸ“Š Applying diagnostic data:', diagnosticData);

            // You can customize the workshop based on their diagnostic answers
            const pitchGoal = diagnosticData['1']; // investor/speaking/sales/networking
            const stage = diagnosticData['2'];     // idea/mvp/traction/growth
            const duration = diagnosticData['3'];  // 60s/3min/10min/20min

            console.log(`ðŸŽ¯ User Profile: ${pitchGoal} | ${stage} | ${duration}`);

            // Store in state for later use
            state.diagnosticData = diagnosticData;
        }

        // ========================================
        // WORKSHOP INITIALIZATION (âœ… FIXED)
        // ========================================

        async function initializeWorkshop() {
            console.log('ðŸš€ Initializing workshop...');

            // Initialize authentication
            const isAuthenticated = await initWorkshopAuth();
            if (!isAuthenticated) {
                return; // Already redirected to login
            }

            // Check if user has completed diagnostic
            if (!currentProject) {
                console.log('âŒ No project found - redirecting to diagnostic');
                window.location.href = '/diagnostic-questionnaire.html';
                return;
            }

            if (!currentProject.diagnostic_completed) {
                console.log('âŒ Diagnostic not completed - redirecting to diagnostic');
                window.location.href = '/diagnostic-questionnaire.html';
                return;
            }

            console.log('âœ… Diagnostic completed - workshop unlocked');
            console.log('âœ… User context loaded:', {
                userId: currentUser?.id,
                userEmail: currentUser?.email,
                projectId: currentProject?.id,
                projectTitle: currentProject?.title,
                diagnosticCompleted: currentProject?.diagnostic_completed
            });

            // Load saved state
            const demoState = PitchPerfect?.DemoState?.load() || { workshop: {}, diagnostic: {} };

            if (demoState.workshop.currentPhase) {
                state.currentPhase = demoState.workshop.currentPhase;
            }

            if (demoState.workshop.phaseCompletion) {
                state.phaseCompletion = demoState.workshop.phaseCompletion;
            }

            // Render sidebar phases
            renderPhases();

            // âœ… FIX 1: Check if we need to restore a phase or show welcome
            if (state.currentPhase) {
                console.log(`ðŸ”„ Restoring Phase ${state.currentPhase}`);

                // Restore chat interface
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('chatMessages').style.display = 'flex';
                document.getElementById('chatInputContainer').style.display = 'block';
                document.getElementById('restartPhaseBtn').classList.add('visible');

                // Update header
                const phase = PHASES.find(p => p.number === state.currentPhase);
                if (phase) {
                    document.querySelector('.chat-title').textContent = `Phase ${state.currentPhase}: ${phase.title}`;
                    document.querySelector('.chat-subtitle').textContent = phase.description;
                }

                // Load messages for this phase
                loadPhaseMessages(state.currentPhase);

            } else {
                console.log('ðŸ“º Showing welcome screen');

                // Show welcome screen for new users
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('chatInputContainer').style.display = 'none';
                document.getElementById('restartPhaseBtn').classList.remove('visible');
            }

            // Mobile menu toggle
            if (window.innerWidth <= 768) {
                document.getElementById('menuToggle').style.display = 'flex';
            }

            // Initialize metrics system
            MetricsSystem.init();

            // Track analytics
            trackEvent('workshop_session_started', {
                completedPhases: getCompletedPhasesCount(),
                progress: calculateProgress(),
                hasCurrentPhase: !!state.currentPhase
            });

            console.log('âœ… Workshop fully initialized', {
                currentPhase: state.currentPhase,
                completedPhases: getCompletedPhasesCount()
            });
        }

        // ========================================
        // ANALYTICS
        // ========================================

        function trackEvent(eventName, properties = {}) {
            const event = {
                event: eventName,
                timestamp: new Date().toISOString(),
                userTier: userProfile?.tier || 'free',
                userId: currentUser?.id || 'anonymous',
                ...properties
            };

            console.log('ðŸ“Š Analytics Event:', event);

            // Store in localStorage for later sync
            const events = JSON.parse(localStorage.getItem('analytics_events') || '[]');
            events.push(event);
            localStorage.setItem('analytics_events', JSON.stringify(events));

            // TODO: Send to analytics service (Google Analytics, Mixpanel, etc.)
        }


        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function renderPhases() {
            const phasesList = document.getElementById('phasesList');
            phasesList.innerHTML = '';

            const userTier = userProfile?.tier || 'free';

            PHASES.forEach(phase => {
                const isCompleted = state.phaseCompletion[phase.number] === true;
                const hasAccess = canAccessPhase(userTier, phase.number);
                const isActive = state.currentPhase === phase.number;

                const card = document.createElement('div');
                card.className = `phase-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''} ${!hasAccess ? 'locked' : ''}`;

                if (hasAccess) {
                    card.onclick = () => {
                        selectPhase(phase.number);
                        if (window.innerWidth <= 768) {
                            toggleSidebar();
                        }
                    };
                } else {
                    card.onclick = () => {
                        showUpgradePrompt(phase.number);
                    };
                }

                // âœ… Build tier badge for locked phases
                let tierBadge = '';
                if (!hasAccess && phase.tier) {
                    const badgeClass = phase.tier === 'core' ? 'core' : 'professional';
                    const badgeText = phase.tier === 'core' ? 'Core' : 'Pro';
                    tierBadge = `<span class="tier-badge ${badgeClass}">${badgeText}</span>`;
                }

                // âœ… Build lock icon
                const lockIcon = !hasAccess ? '<span class="phase-lock-icon">ðŸ”’</span>' : '';

                // âœ… Build estimated time display
                const timeInfo = phase.estimatedTime ?
                    `<div class="phase-estimated-time">
                <span>â±ï¸</span>
                <span>${phase.estimatedTime}</span>
            </div>` : '';

                card.innerHTML = `
            <div class="phase-header">
                <div class="phase-number">${isCompleted ? 'âœ“' : phase.number}</div>
                <div class="phase-title">
                    ${phase.title}
                    ${tierBadge}
                    ${lockIcon}
                </div>
            </div>
            <div class="phase-description">${phase.description}</div>
            ${timeInfo}
        `;

                phasesList.appendChild(card);
            });

            updateProgressBar();
        }

        // ========================================
        // PROGRESS BAR UPDATES
        // ========================================

        function updateProgressBar() {
            const completedCount = getCompletedPhasesCount();
            const totalPhases = PHASES.length;
            const percentage = calculateProgress();

            // Update percentage text with animation
            const percentageEl = document.getElementById('progressPercentage');
            if (percentageEl) {
                percentageEl.textContent = `${percentage}%`;
                percentageEl.style.animation = 'none';
                setTimeout(() => {
                    percentageEl.style.animation = 'numberPulse 0.5s ease';
                }, 10);
            }

            // Update progress bar width
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
            }

            // Update completed count
            const completedCountEl = document.getElementById('completedCount');
            if (completedCountEl) {
                completedCountEl.textContent = completedCount;
            }

            console.log(`ðŸ“Š Progress updated: ${completedCount}/${totalPhases} (${percentage}%)`);
        }

        function selectPhase(phaseNumber) {
            console.log(`ðŸŽ¯ === selectPhase START === Phase ${phaseNumber}`);
            console.log(`ðŸ” Before: state.currentPhase =`, state.currentPhase);

            // Check if user has access to this phase
            const userTier = userProfile?.tier || 'free';

            if (!canAccessPhase(userTier, phaseNumber)) {
                console.log(`ðŸ”’ Phase ${phaseNumber} locked for ${userTier} tier`);
                showUpgradePrompt(phaseNumber);
                return;
            }

            console.log(`âœ… Access granted to Phase ${phaseNumber}`);

            state.currentPhase = phaseNumber;
            console.log(`ðŸ” After setting: state.currentPhase =`, state.currentPhase);

            state.messages = [];

            const phase = PHASES.find(p => p.number === phaseNumber);

            console.log('ðŸŽ¨ Updating UI elements...');

            // âœ… CRITICAL: Set display explicitly and verify
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInputContainer');
            const restartBtn = document.getElementById('restartPhaseBtn');

            welcomeScreen.style.display = 'none';
            chatMessages.style.display = 'flex';
            chatInput.style.display = 'block';
            restartBtn.classList.add('visible');

            console.log('UI State after update:', {
                welcome: welcomeScreen.style.display,
                chat: chatMessages.style.display,
                input: chatInput.style.display
            });

            // Update header
            document.querySelector('.chat-title').textContent = `Phase ${phaseNumber}: ${phase.title}`;
            document.querySelector('.chat-subtitle').textContent = phase.description;

            // Render and load
            renderPhases();
            loadPhaseMessages(phaseNumber);

            // Track
            trackEvent('phase_started', {
                phase: phaseNumber,
                userTier: userTier
            });

            // Save state
            const demoState = PitchPerfect.DemoState.load();
            demoState.workshop.currentPhase = phaseNumber;
            PitchPerfect.DemoState.save(demoState);

            console.log('ðŸ” About to call showReadinessButton()');
            showReadinessButton();

            console.log('âœ… === selectPhase END ===');
        }

        function loadPhaseMessages(phaseNumber) {
            console.log(`ðŸ“¥ Loading messages for Phase ${phaseNumber}`);

            // âœ… NEW: Special handling for Phase 2 with pitch analysis
            if (phaseNumber === 2) {
                const pitchDraft = localStorage.getItem('userPitchDraft');
                const analysisData = localStorage.getItem('pitchAnalysis');

                if (pitchDraft && analysisData) {
                    try {
                        const analysis = JSON.parse(analysisData).analysis;

                        // Store in global context for AI system prompt
                        window.pitchContext = {
                            draft: pitchDraft,
                            score: analysis.overallScore,
                            errors: analysis.fatalErrors,
                            strengths: analysis.strengths || []
                        };

                        console.log('âœ… Loaded pitch context for Phase 2:', window.pitchContext);

                        // Check if we already have saved messages for this phase
                        const demoState = PitchPerfect.DemoState.load();
                        const savedMessages = demoState.workshop.messages[phaseNumber] || [];

                        if (savedMessages.length > 0) {
                            // User is returning to Phase 2 - load their conversation
                            state.messages = savedMessages;
                            renderMessages();
                            console.log('âœ… Rendered saved Phase 2 messages');
                            return;
                        }

                        // Build custom initial message referencing their specific errors
                        const errorsList = analysis.fatalErrors
                            .map((err, i) => {
                                let errorText = `**${i + 1}. ${err.title}**\n   ${err.impact}`;

                                // Add evidence quote if available
                                if (err.evidence) {
                                    errorText += `\n   \n   ðŸ“ *"${err.evidence}"*`;
                                }

                                return errorText;
                            })
                            .join('\n\n');

                        const initialMessage = `Willkommen in Phase 2! ðŸŽ¯

Ich habe deinen Pitch analysiert und **${analysis.fatalErrors.length} kritische Fehler** gefunden, die wir jetzt gemeinsam beheben werden.

**Deine aktuellen Fehler:**

${errorsList}

Lass uns mit dem ersten Fehler beginnen: **${analysis.fatalErrors[0].title}**

${analysis.fatalErrors[0].fix}

Bist du bereit, diesen Fehler anzugehen?`;

                        // Add initial message to state and display
                        addMessage('assistant', initialMessage);
                        console.log('âœ… Added custom Phase 2 intro with specific errors');

                        return; // Exit early - we've handled Phase 2 specially

                    } catch (error) {
                        console.error('Error loading pitch analysis:', error);
                        // Fall through to default behavior
                    }
                }
            }

            // âœ… DEFAULT BEHAVIOR: For all other phases or if no analysis
            const demoState = PitchPerfect.DemoState.load();
            const savedMessages = demoState.workshop.messages[phaseNumber] || [];

            console.log(`Found ${savedMessages.length} saved messages`);

            if (savedMessages.length > 0) {
                state.messages = savedMessages;
                renderMessages();
                console.log('âœ… Rendered saved messages');
            } else {
                const welcomeMessage = getPhaseWelcomeMessage(phaseNumber);
                addMessage('assistant', welcomeMessage);
                console.log('âœ… Added welcome message');
            }

            // âœ… VERIFY: Check if messages are actually visible
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                const messageCount = chatMessages.querySelectorAll('.message').length;
                console.log(`ðŸ” Verification: ${messageCount} messages in DOM, display: ${chatMessages.style.display}`);
            }, 100);
        }

        function getPhaseWelcomeMessage(phaseNumber) {
            const messages = {
                2: "Lass uns die kritischen LÃ¼cken aus deiner Diagnose systematisch angehen. Beginnen wir mit der grÃ¶ÃŸten: **Deine Problemstellung**. \n\nErzÃ¤hl mir: Was ist das GENAUE Problem, das du lÃ¶st? Wer hat es? Wie viel kostet es sie?",
                3: "Zeit fÃ¼r tiefe Befragung deines Problems. Ich werde dich herausfordern, vage Aussagen vermeiden und dich zwingen, spezifisch zu sein.\n\nBeginnen wir: **Wer GENAU** hat dieses Problem? Gib mir eine Persona, keine allgemeine Gruppe.",
                4: "Lass uns deine LÃ¶sung kristallklar machen. Der Oma-Test: Kann deine GroÃŸmutter verstehen, was du in 30 Sekunden machst?\n\nErklÃ¤re mir: Was machen Kunden ANDERS, nachdem sie deine LÃ¶sung nutzen?",
                5: "MarktgrÃ¶ÃŸe ist entscheidend. Aber die meisten GrÃ¼nder machen es falsch - sie nutzen Top-down-Fantasiezahlen.\n\nZeig mir: **Wie viele** Zielkunden existieren? Gib mir die tatsÃ¤chliche Zahl.",
                6: "Unit Economics entscheiden Ã¼ber Leben und Tod. Wenn deine Zahlen nicht aufgehen, ist alles andere egal.\n\nSag mir: Was ist dein **CAC** (Customer Acquisition Cost)? Und dein **LTV** (Lifetime Value)?",
                7: "Traktion ist der ultimative Beweis. Zahlen lÃ¼gen nicht.\n\nWas ist dein aktueller **MRR/ARR**? Oder wenn du noch keinen Umsatz hast, welche Validierungssignale hast du?",
                8: "Investoren investieren in Menschen, nicht nur in Ideen.\n\nWarum ist **dein Team** einzigartig qualifiziert, dies aufzubauen? Welche relevante Erfahrung bringst du mit?",
                9: "\"Wir haben keine Konkurrenz\" ist die schlechteste Antwort. Jeder hat Konkurrenz, selbst wenn es Excel ist.\n\nWas nutzen Leute **HEUTE** statt deiner LÃ¶sung?",
                10: "Wenn du Geld sammelst, musst du genau wissen: wie viel, wofÃ¼r und welche Meilensteine.\n\n**Wie viel** sammelst du? Und was machst du GENAU damit?",
                11: "Jetzt optimieren wir, wie du deine Geschichte erzÃ¤hlst. Die ersten 30 Sekunden entscheiden alles.\n\nWas ist dein **ErÃ¶ffnungshaken**? Wie fÃ¤ngst du an?",
                12: "Zeit, fÃ¼r die hÃ¤rtesten Investorenfragen vorzubereiten. Die, die dich ins Schwitzen bringen.\n\nBereit? Erste Frage: **\"Warum wird das NICHT funktionieren?\"**",
                13: "Finale ÃœberprÃ¼fung! Lass uns durch alle 10 Kernelemente gehen und sicherstellen, dass alles solide ist.\n\nBeginnen wir: Ist deine **Problemstellung** kristallklar und quantifiziert?"
            };
            return messages[phaseNumber] || "Willkommen zu dieser Phase! Lass uns beginnen.";
        }

        function renderMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            state.messages.forEach(msg => {
                const messageEl = createMessageElement(msg.role, msg.content);
                chatMessages.appendChild(messageEl);
            });

            scrollToBottom();
        }

        function addMessage(role, content) {
            state.messages.push({ role, content, timestamp: new Date() });

            const messageEl = createMessageElement(role, content);
            document.getElementById('chatMessages').appendChild(messageEl);

            saveMessages();
            scrollToBottom();
        }

        function createMessageElement(role, content) {
            const div = document.createElement('div');
            div.className = `message ${role}`;

            const avatar = role === 'assistant' ? 'AI' : 'DU';
            const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${formatMessage(content)}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            return div;
        }

        function formatMessage(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typing-indicator';
            indicator.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('chatMessages').appendChild(indicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || state.isTyping) return;

            input.value = '';
            input.style.height = 'auto';

            addMessage('user', message);

            state.isTyping = true;
            document.getElementById('sendButton').disabled = true;
            showTypingIndicator();

            try {
                // âœ… NEW: Get current user and project
                const userId = currentUser?.id || null;
                const projectId = currentProject?.id || null;

                console.log('ðŸ“¤ Sending message with context:', {
                    phase: state.currentPhase,
                    userId: userId ? 'present' : 'missing',
                    projectId: projectId ? 'present' : 'missing'
                });

                // Build conversation history
                const conversationHistory = state.messages.map(m => ({
                    role: m.role === 'user' ? 'user' : 'assistant',
                    content: m.content
                }));

                // âœ… NEW: Include pitch context if available (for Phase 2)
                let pitchContext = null;
                if (state.currentPhase === 2 && window.pitchContext) {
                    pitchContext = window.pitchContext;
                    console.log('ðŸ“Š Including pitch context for Phase 2');
                }

                // Call API with enhanced context
                const response = await fetch('/api/chat-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phase: state.currentPhase,
                        message: message,
                        conversationHistory: conversationHistory,
                        pitchContext: pitchContext,
                        userId: userId,        // âœ… NEW
                        projectId: projectId   // âœ… NEW
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                console.log('âœ… API response:', {
                    contentLength: data.content?.length,
                    phaseComplete: data.phaseComplete,
                    xmlParsed: data.metadata?.xmlParsed,
                    turn: data.metadata?.turn
                });

                removeTypingIndicator();
                addMessage('assistant', data.content);

                // Check if phase is complete
                if (data.phaseComplete) {
                    setTimeout(() => completePhase(), 1000);
                }

                // Log metrics if available
                if (data.metrics) {
                    console.log('ðŸ“Š API Metrics:', {
                        latency: `${data.metrics.latency_ms}ms`,
                        tokens: `${data.metrics.input_tokens} in / ${data.metrics.output_tokens} out`,
                        cacheRead: data.metrics.cache_read_tokens,
                        cost: `$${data.metrics.cost_usd}`
                    });
                }

            } catch (error) {
                console.error('âŒ Error sending message:', error);
                removeTypingIndicator();
                addMessage('assistant', 'Entschuldigung, es gab ein Problem. Bitte versuche es erneut.');
            }

            state.isTyping = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
        }

        function completePhase() {
            state.phaseCompletion[state.currentPhase] = true;

            const demoState = PitchPerfect.DemoState.load();
            demoState.workshop.phaseCompletion = state.phaseCompletion;
            PitchPerfect.DemoState.save(demoState);

            const nextPhaseNumber = state.currentPhase + 1;
            const nextPhase = PHASES.find(p => p.number === nextPhaseNumber);

            if (nextPhase) {
                nextPhase.unlocked = true;
                document.getElementById('modalMessage').textContent =
                    `GroÃŸartige Arbeit! Du hast "${PHASES.find(p => p.number === state.currentPhase).title}" abgeschlossen. Bereit fÃ¼r die nÃ¤chste?`;
            }

            renderPhases();

            triggerPhaseCompletionCelebration();

            document.getElementById('modalOverlay').classList.add('active');
        }

        function triggerPhaseCompletionCelebration() {
            const completedCount = getCompletedPhasesCount();
            const percentage = calculateProgress();

            // Update progress bar with celebration
            updateProgressBar();

            // Show confetti
            showConfetti();

            // Track milestone achievements
            if (completedCount === 3) {
                showMilestoneMessage('ðŸŽ‰ Erste 3 Phasen abgeschlossen!', 'Du bist auf einem groÃŸartigen Weg!');
            } else if (completedCount === 6) {
                showMilestoneMessage('ðŸ”¥ Halbzeit erreicht!', 'Du bist schon bei 50%!');
            } else if (completedCount === 9) {
                showMilestoneMessage('âš¡ Nur noch 3 Phasen!', 'Du bist fast am Ziel!');
            } else if (completedCount === 12) {
                showMilestoneMessage('ðŸŽŠ Alle Phasen abgeschlossen!', 'Dein Pitch ist jetzt perfekt!');
            }

            // Track analytics
            trackEvent('phase_completed', {
                phase: state.currentPhase,
                totalCompleted: completedCount,
                progress: percentage,
                userTier: userProfile?.tier || 'free'
            });
        }

        function showConfetti() {
            const colors = ['#667eea', '#764ba2', '#D97706', '#059669', '#DC2626'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';

                document.body.appendChild(confetti);

                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function showMilestoneMessage(title, message) {
            const milestone = document.createElement('div');
            milestone.className = 'milestone-message';
            milestone.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
            `;

            document.body.appendChild(milestone);

            setTimeout(() => {
                milestone.style.animation = 'milestonePopIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) reverse forwards';
                setTimeout(() => milestone.remove(), 300);
            }, 2500);
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function nextPhase() {
            closeModal();
            const nextPhaseNumber = state.currentPhase + 1;
            const nextPhase = PHASES.find(p => p.number === nextPhaseNumber);

            if (nextPhase) {
                selectPhase(nextPhaseNumber);
            }
        }

        function saveMessages() {
            const demoState = PitchPerfect.DemoState.load();
            if (!demoState.workshop.messages) {
                demoState.workshop.messages = {};
            }
            demoState.workshop.messages[state.currentPhase] = state.messages;
            PitchPerfect.DemoState.save(demoState);
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        document.addEventListener('DOMContentLoaded', function () {
            const chatInput = document.getElementById('chatInput');

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        });

        document.addEventListener('click', function (e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const menuToggle = document.getElementById('menuToggle');

                if (sidebar.classList.contains('open') &&
                    !sidebar.contains(e.target) &&
                    !menuToggle.contains(e.target)) {
                    toggleSidebar();
                }
            }
        });

        // Keyboard shortcut: Ctrl+Shift+M for metrics (admin only)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'M') {
                e.preventDefault();
                const btn = document.getElementById('metricsToggleBtn');
                if (btn.classList.contains('visible')) {
                    toggleMetrics();
                } else {
                    // Enable admin mode
                    localStorage.setItem('pitchperfect_admin', 'true');
                    MetricsSystem.enableMetrics();
                    toggleMetrics();
                }
            }
        });

        // Close metrics on overlay click
        document.getElementById('metricsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'metricsOverlay') {
                toggleMetrics();
            }
        });

        // Close restart modal on overlay click
        document.getElementById('restartModal').addEventListener('click', (e) => {
            if (e.target.id === 'restartModal') {
                closeRestartModal();
            }
        });

        window.addEventListener('load', initializeWorkshop);

        window.addEventListener('resize', function () {
            if (window.innerWidth <= 768) {
                document.getElementById('menuToggle').style.display = 'flex';
            } else {
                document.getElementById('menuToggle').style.display = 'none';
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        // ========================================
        // PHASE READINESS EVALUATION
        // ========================================

        async function checkPhaseReadiness() {
            if (!state.currentPhase) {
                alert('Bitte wÃ¤hle zuerst eine Phase aus.');
                return;
            }

            if (state.messages.length < 2) {
                alert('Arbeite erst etwas an dieser Phase, bevor du die Bereitschaft prÃ¼fst.');
                return;
            }

            const btn = document.getElementById('checkReadinessBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Analysiere...';

            try {
                console.log('ðŸŽ¯ Checking readiness for Phase', state.currentPhase);

                // Build conversation history
                const conversationHistory = state.messages.map(m => ({
                    role: m.role === 'user' ? 'user' : 'assistant',
                    content: m.content
                }));

                // Call evaluation API
                const response = await fetch('/api/evaluate-phase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phase: state.currentPhase,
                        conversationHistory: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`Evaluation failed: ${response.status}`);
                }

                const result = await response.json();
                console.log('âœ… Evaluation result:', result);

                // Display results
                displayEvaluationResults(result.evaluation);

                // Track analytics
                trackEvent('phase_readiness_checked', {
                    phase: state.currentPhase,
                    score: result.evaluation.score,
                    canProceed: result.evaluation.canProceed
                });

            } catch (error) {
                console.error('âŒ Evaluation error:', error);
                alert('Fehler bei der Auswertung. Bitte versuche es erneut.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ðŸŽ¯ Check Readiness - Bin ich bereit?';
            }
        }

        function displayEvaluationResults(evaluation) {
            const resultsDiv = document.getElementById('evaluationResults');

            // Determine score category
            let scoreClass = 'needs-work';
            let scoreLabel = 'Noch Arbeit nÃ¶tig';

            if (evaluation.score >= 80) {
                scoreClass = 'excellent';
                scoreLabel = 'Ausgezeichnet!';
            } else if (evaluation.score >= 70) {
                scoreClass = 'good';
                scoreLabel = 'Gut - Bereit zum Fortfahren!';
            }

            // Build must-meet criteria display
            const mustMeetItems = Object.entries(evaluation.mustMeetResults || {})
                .map(([key, met]) => {
                    const criterion = getPhaseCriteria(state.currentPhase).mustMeet.find(c => c.id === key);
                    return `
                <div class="criterion-item">
                    <div class="criterion-icon ${met ? 'met' : 'missing'}">
                        ${met ? 'âœ“' : 'âœ—'}
                    </div>
                    <div class="criterion-text">
                        ${criterion ? criterion.label : key}
                    </div>
                </div>
            `;
                }).join('');

            // Build should-meet criteria display
            const shouldMeetItems = Object.entries(evaluation.shouldMeetResults || {})
                .map(([key, met]) => {
                    const criterion = getPhaseCriteria(state.currentPhase).shouldMeet.find(c => c.id === key);
                    return `
                <div class="criterion-item">
                    <div class="criterion-icon ${met ? 'met' : 'missing'}">
                        ${met ? 'âœ“' : 'âœ—'}
                    </div>
                    <div class="criterion-text">
                        ${criterion ? criterion.label : key}
                    </div>
                </div>
            `;
                }).join('');

            // Build gaps list
            const gapsList = evaluation.gaps && evaluation.gaps.length > 0
                ? `<ul class="gaps-list">${evaluation.gaps.map(gap => `<li>${gap}</li>`).join('')}</ul>`
                : '';

            // Build complete UI
            const closeButtonHTML = `
        <button 
            onclick="hideEvaluationResults()" 
            style="position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; background: white; border: 2px solid var(--border); border-radius: 50%; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10; color: var(--text-medium); font-weight: 700;"
            onmouseover="this.style.background='var(--error)'; this.style.color='white'; this.style.borderColor='var(--error)'"
            onmouseout="this.style.background='white'; this.style.color='var(--text-medium)'; this.style.borderColor='var(--border)'"
            title="Ergebnisse ausblenden"
        >
            âœ•
        </button>
    `;

            const scoreHTML = `
        <div class="score-display">
            <div class="score-circle-large ${scoreClass}">
                ${evaluation.score}
            </div>
            <div class="score-label">${scoreLabel}</div>
        </div>
    `;

            const feedbackHTML = evaluation.feedback ? `
        <div class="feedback-box">
            <strong>ðŸ“ Feedback:</strong>
            <p>${evaluation.feedback}</p>
        </div>
    ` : '';

            const mustMeetHTML = mustMeetItems ? `
        <div class="criteria-section">
            <div class="criteria-title">âœ“ Erforderliche Kriterien</div>
            ${mustMeetItems}
        </div>
    ` : '';

            const shouldMeetHTML = shouldMeetItems ? `
        <div class="criteria-section">
            <div class="criteria-title">â­ Bonus-Kriterien</div>
            ${shouldMeetItems}
        </div>
    ` : '';

            const gapsHTML = gapsList ? `
        <div class="feedback-box">
            <strong>ðŸŽ¯ Was noch fehlt:</strong>
            ${gapsList}
        </div>
    ` : '';

            const nextStepsHTML = evaluation.nextSteps ? `
        <div class="feedback-box">
            <strong>âž¡ï¸ NÃ¤chster Schritt:</strong>
            <p>${evaluation.nextSteps}</p>
        </div>
    ` : '';

            const buttonsHTML = `
        <div class="action-buttons">
            ${evaluation.canProceed ? `
                <button 
                    class="action-button primary" 
                    onclick="completePhaseWithScore(${evaluation.score})"
                >
                    âœ“ Phase AbschlieÃŸen
                </button>
            ` : ''}
            <button 
                class="action-button ${evaluation.canProceed ? 'secondary' : 'primary'}" 
                onclick="hideEvaluationResults()"
            >
                ${evaluation.canProceed ? 'â† ZurÃ¼ck zum Chat' : 'â† Weiter arbeiten (' + evaluation.score + '/70)'}
            </button>
        </div>
    `;

            resultsDiv.innerHTML = `
        <div class="evaluation-card" style="position: relative;">
            ${closeButtonHTML}
            ${scoreHTML}
            ${feedbackHTML}
            ${mustMeetHTML}
            ${shouldMeetHTML}
            ${gapsHTML}
            ${nextStepsHTML}
            ${buttonsHTML}
        </div>
    `;

            resultsDiv.style.display = 'block';

            // Scroll to results
            setTimeout(() => {
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function getPhaseCriteria(phaseNumber) {
            // Phase criteria definitions (matching api/evaluate-phase.js)
            const PHASE_CRITERIA = {
                2: {
                    mustMeet: [
                        { id: 'persona_identified', label: 'Spezifische Persona/Kunde identifiziert' },
                        { id: 'problem_described', label: 'Problem klar artikuliert' },
                        { id: 'hook_present', label: 'ErÃ¶ffnungshaken vorhanden' }
                    ],
                    shouldMeet: [
                        { id: 'problem_quantified', label: 'Problem mit Zahlen quantifiziert', weight: 20 },
                        { id: 'alternative_mentioned', label: 'Aktuelle LÃ¶sung/Alternative erwÃ¤hnt', weight: 15 },
                        { id: 'specific_example', label: 'Spezifisches, lebendiges Beispiel enthalten', weight: 15 }
                    ]
                },
                3: {
                    mustMeet: [
                        { id: 'specific_persona', label: 'Spezifische Persona mit demografischen Details' },
                        { id: 'quantified_pain', label: 'Problem in â‚¬/Zeit/messbarer Metrik quantifiziert' },
                        { id: 'current_alternative', label: 'Was Kunden HEUTE nutzen identifiziert' }
                    ],
                    shouldMeet: [
                        { id: 'market_timing', label: 'ErklÃ¤rt warum JETZT (Market Timing)', weight: 25 },
                        { id: 'validation_evidence', label: 'Validierungs-Beweise (Interviews/Daten)', weight: 25 }
                    ]
                },
                // Add more phases as needed
            };

            return PHASE_CRITERIA[phaseNumber] || { mustMeet: [], shouldMeet: [] };
        }

        function hideEvaluationResults() {
            document.getElementById('evaluationResults').style.display = 'none';
        }

        function completePhaseWithScore(score) {
            console.log(`âœ… Completing phase ${state.currentPhase} with score ${score}`);

            // Store score
            if (!state.phaseScores) {
                state.phaseScores = {};
            }
            state.phaseScores[state.currentPhase] = score;

            // Mark as complete
            completePhase();
        }

        // Show readiness button when phase starts
        function showReadinessButton() {
            console.log('ðŸ” === SHOW READINESS BUTTON START ===');

            const section = document.getElementById('readinessSection');
            const chatInputContainer = document.getElementById('chatInputContainer');

            console.log('ðŸ” section exists:', !!section);
            console.log('ðŸ” state.currentPhase:', state.currentPhase);
            console.log('ðŸ” chatInputContainer display:', chatInputContainer?.style.display);

            if (!section) {
                console.error('âŒ readinessSection element NOT FOUND!');
                return;
            }

            if (!state.currentPhase) {
                console.error('âŒ No current phase set! Cannot show button.');
                return;
            }

            // Force display
            section.style.display = 'block';
            console.log('âœ… Readiness button display set to: block');
            console.log('ðŸ” Final section.style.display:', section.style.display);
            console.log('ðŸ” === SHOW READINESS BUTTON END ===');
        }

        // Hide readiness button
        function hideReadinessButton() {
            const section = document.getElementById('readinessSection');
            if (section) {
                section.style.display = 'none';
            }
        }
        // ========================================
            // DEBUG: User Context Checker
            // ========================================
            function checkUserContext() {
                console.group('ðŸ” User Context Check');

                console.log('currentUser:', currentUser ? {
                    id: currentUser.id,
                    email: currentUser.email,
                    created_at: currentUser.created_at
                } : 'âŒ NOT LOADED');

                console.log('userProfile:', userProfile ? {
                    tier: userProfile.tier,
                    full_name: userProfile.full_name
                } : 'âŒ NOT LOADED');

                console.log('currentProject:', currentProject ? {
                    id: currentProject.id,
                    title: currentProject.title,
                    diagnostic_completed: currentProject.diagnostic_completed,
                    diagnostic_data: currentProject.diagnostic_data ? 'present' : 'missing'
                } : 'âŒ NOT LOADED');

                console.log('state.currentPhase:', state.currentPhase || 'not set');
                console.log('state.messages.length:', state.messages.length);

                console.groupEnd();
            }

            // Auto-check on page load
            window.addEventListener('load', () => {
                setTimeout(() => {
                    console.log('ðŸ” Auto-checking user context...');
                    checkUserContext();
                }, 2000);
            });

            // Make available in console for manual checking
            window.checkUserContext = checkUserContext;
    </script>
</body>

</html>