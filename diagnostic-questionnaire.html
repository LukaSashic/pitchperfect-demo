<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch-Diagnose - PitchPerfect AI</title>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="pitchperfect-connector.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px 16px 0 0;
            padding: 32px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .header .research-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .progress-bar {
            background: white;
            padding: 20px 32px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .progress-track {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
            text-align: right;
        }

        .question-card {
            background: white;
            padding: 40px;
            display: none;
        }

        .question-card.active {
            display: block;
        }

        .question-number {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .question-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .question-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            padding: 12px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .option-label {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .option-description {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Enhanced Q4: Two-part input */
        .dual-input-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .input-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            transition: border-color 0.2s ease;
        }

        .input-section:focus-within {
            border-color: #667eea;
        }

        .input-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-hint {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
        }

        .text-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            background: white;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .char-counter {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 4px;
        }

        .char-counter.valid {
            color: #10b981;
        }

        .char-counter.invalid {
            color: #ef4444;
        }

        .example-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
        }

        .example-box strong {
            color: #10b981;
        }

        /* Q9: CTA Input */
        .cta-text-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            margin-top: 16px;
            display: none;
        }

        .cta-text-input.show {
            display: block;
        }

        .cta-text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .buttons {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            gap: 16px;
        }

        .btn {
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            background: white;
            border-radius: 16px;
            padding: 40px;
            display: none;
        }

        .results.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Validation feedback */
        .validation-message {
            font-size: 13px;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            display: none;
        }

        .validation-message.show {
            display: block;
        }

        .validation-message.success {
            background: #f0fdf4;
            color: #10b981;
            border: 1px solid #86efac;
        }

        .validation-message.error {
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fca5a5;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéØ Pitch-Diagnose</h1>
            <p>6-Minuten-Analyse f√ºr deinen perfekten Pitch</p>
            <span class="research-badge">üî¨ Wissenschaftlich fundiert</span>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 9</div>
        </div>

        <!-- Question Cards -->
        <div id="questionsContainer"></div>

        <!-- Navigation Buttons -->
        <div class="buttons">
            <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">
                ‚Üê Zur√ºck
            </button>
            <div style="flex: 1"></div>
            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>
                Weiter ‚Üí
            </button>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            <div class="loading" id="loadingResults">
                <div class="spinner"></div>
                <p style="margin-top: 20px; color: #666;">Analysiere deinen Pitch mit 9 wissenschaftlichen Methoden...
                </p>
            </div>
            <div id="resultsContent" style="display: none;"></div>
        </div>
    </div>

    <script src="auth-guard.js"></script>
    <script>
        // Enhanced questions with research backing
        const questions = [
            {
                id: 1,
                question: "Was ist dein Hauptziel mit diesem Pitch?",
                subtitle: "üé≤ Game Theory: Unterschiedliche Ziele = unterschiedliche strategische Spiele",
                type: "choice",
                options: [
                    { value: "investor", label: "Investoren √ºberzeugen", description: "Finanzierung f√ºr mein Startup" },
                    { value: "speaking", label: "Publikum begeistern", description: "Vortrag oder Pr√§sentation" },
                    { value: "sales", label: "Kunden gewinnen", description: "Produkt/Service verkaufen" },
                    { value: "networking", label: "Netzwerk erweitern", description: "BNI, Business-Events" }
                ]
            },
            {
                id: 2,
                question: "In welcher Phase befindet sich dein Business?",
                subtitle: "üë• Social Psychology: Jede Phase braucht unterschiedliche Autorit√§tssignale",
                type: "choice",
                options: [
                    { value: "idea", label: "Idee", description: "Konzept in der Entwicklung" },
                    { value: "mvp", label: "MVP", description: "Erstes Produkt gebaut" },
                    { value: "traction", label: "Erste Kunden", description: "Umsatz wird generiert" },
                    { value: "growth", label: "Wachstum", description: "Skalierung l√§uft" }
                ]
            },
            {
                id: 3,
                question: "Wie viel Zeit hast du f√ºr deinen Pitch?",
                subtitle: "üß† Cognitive Psychology: Zeit bestimmt kognitive Last (Miller's 7¬±2)",
                type: "choice",
                options: [
                    { value: "60s", label: "60 Sekunden", description: "BNI oder schnelles Networking (1 Kernbotschaft)" },
                    { value: "3min", label: "3 Minuten", description: "Kurze Pr√§sentation (3 Botschaften)" },
                    { value: "10min", label: "10 Minuten", description: "Detaillierter Pitch (7 Botschaften)" },
                    { value: "20min", label: "20+ Minuten", description: "Ausf√ºhrliche Pr√§sentation" }
                ]
            },
            {
                id: 4,
                question: "Beschreibe Problem & L√∂sung:",
                subtitle: "üß¨ Neuroscience + üí° Behavioral Science: Loss Aversion aktiviert Amygdala 2x st√§rker",
                type: "dual-text",
                parts: [
                    {
                        id: "problem",
                        label: "A) Was ist der gr√∂√üte VERLUST/SCHMERZ deiner Zielgruppe?",
                        hint: "Quantifiziere den Schmerz mit Zahlen (Zeit, Geld, Opportunit√§tskosten)",
                        placeholder: "Beispiel: 'Gr√ºnder verlieren 70 unvorhersehbare Tage pro Deal durch inkonsistente Pitches'",
                        minChars: 20,
                        maxChars: 200,
                        example: "‚úÖ Gut: 'Deine Konkurrenten schlie√üen Deals in 20 Tagen, w√§hrend du 90 Tage verschwendest'\n‚ùå Schlecht: 'Unternehmen haben ineffiziente Prozesse'"
                    },
                    {
                        id: "solution",
                        label: "B) Wie l√∂st du das KONKRET?",
                        hint: "Beschreibe den MECHANISMUS, nicht nur das Ergebnis",
                        placeholder: "Beispiel: 'KI-gest√ºtzte Pitch-Analyse + 12-Phasen-Workshop = 70% k√ºrzere Deal-Cycles'",
                        minChars: 20,
                        maxChars: 200,
                        example: "‚úÖ Gut: 'Durch automatisierte Sentiment-Analyse + strukturiertes Coaching reduzieren wir...'\n‚ùå Schlecht: 'Wir helfen Unternehmen erfolgreicher zu sein'"
                    }
                ]
            },
            {
                id: 5,
                question: "Wer ist deine Zielgruppe?",
                subtitle: "üì¢ Communication Science: Personalisierung erh√∂ht Response um 30%",
                type: "text",
                placeholder: "Beispiel: 'CFOs in FinTech-Startups (10-50 Mitarbeiter), die Fundraising planen'\n\nSEI SPEZIFISCH: Rolle + Branche + Unternehmensgr√∂√üe"
            },
            {
                id: 6,
                question: "Was macht dich einzigartig?",
                subtitle: "üë• Social Psychology: Authority + Social Proof = Multiplicative Trust Effect",
                type: "text",
                placeholder: "Beispiel: '15+ Jahre Pitch-Coaching + 500 finanzierte Startups + TechCrunch Featured'\n\nKombiniere: Expertise + Zahlen + Externe Validierung"
            },
            {
                id: 7,
                question: "Beste und schlechteste Sales Cycle Dauer (letzte 6 Monate)?",
                subtitle: "üìä Data Science: Varianz zeigt systemische Inkonsistenz",
                type: "choice",
                options: [
                    { value: "consistent", label: "Konsistent (¬±10 Tage)", description: "Stabile Prozesse" },
                    { value: "moderate", label: "Moderat (¬±20-30 Tage)", description: "Leichte Schwankungen" },
                    { value: "high", label: "Hoch (¬±40-60 Tage)", description: "Deutliche Unterschiede" },
                    { value: "extreme", label: "Extrem (¬±70+ Tage)", description: "V√∂llig unvorhersehbar" }
                ]
            },
            {
                id: 8,
                question: "Hast du bereits einen Pitch vorbereitet?",
                subtitle: "ü§ñ AI/ML: Bestehender Pitch erm√∂glicht Pattern-Matching mit 85% Genauigkeit",
                type: "choice",
                options: [
                    { value: "yes", label: "Ja", description: "Ich habe einen fertigen Pitch" },
                    { value: "draft", label: "Entwurf", description: "Ich habe Ideen gesammelt" },
                    { value: "no", label: "Nein", description: "Ich fange bei Null an" }
                ]
            },
            {
                id: 9,
                question: "Was soll dein Publikum NACH dem Pitch tun?",
                subtitle: "üß† Cognitive Psychology: Klarer CTA reduziert Entscheidungslast um 80%",
                type: "choice-with-text",
                options: [
                    { value: "meeting", label: "Meeting buchen", description: "Demo-Call, Due Diligence..." },
                    { value: "trial", label: "Trial starten", description: "Kostenlos testen" },
                    { value: "invest", label: "Investieren", description: "Term Sheet unterzeichnen" },
                    { value: "contact", label: "Kontakt aufnehmen", description: "Visitenkarten tauschen" },
                    { value: "buy", label: "Kaufen", description: "Direkt bestellen/buchen" },
                    { value: "unclear", label: "Unklar", description: "Ich bin mir nicht sicher" }
                ],
                textPlaceholder: "Beschreibe die SPEZIFISCHE Aktion (z.B. 'Buche jetzt deine 15-Min-Demo unter...')",
                showTextFor: ["meeting", "trial", "invest", "contact", "buy"]
            }
        ];

        // State
        let currentQuestion = 0;
        let answers = {};
        let currentUser = null;
        let userProfile = null;

        // Initialize
        async function init() {
            // Check authentication
            const authData = await getCurrentUserWithProfile();
            if (!authData) return;

            currentUser = authData.user;
            userProfile = authData.profile;

            await loadSavedProgress();
            renderQuestions();
            showQuestion(currentQuestion);
            updateProgress();
        }

        async function loadSavedProgress() {
            try {
                const { data, error } = await supabaseClient
                    .from('pitch_projects')
                    .select('diagnostic_data')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (data && data.length > 0 && data[0].diagnostic_data) {
                    answers = data[0].diagnostic_data;

                    // ‚úÖ MIGRATION: Convert old Q4 format to new format
                    if (answers[4] && typeof answers[4] === 'string') {
                        console.log('[MIGRATION] Converting old Q4 format');
                        const oldValue = answers[4];
                        answers[4] = {
                            problem: oldValue,
                            solution: ''
                        };
                        console.log('[MIGRATION] Converted Q4:', answers[4]);
                    }

                    console.log('Loaded saved progress (migrated):', answers);
                }
            } catch (error) {
                console.log('Starting fresh:', error.message);
            }
        }

        // Render all questions
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `question-${index}`;

                let optionsHTML = '';

                if (q.type === 'choice') {
                    optionsHTML = `
                        <div class="options">
                            ${q.options.map(opt => `
                                <div class="option" onclick="selectOption(${index}, '${opt.value}')">
                                    <div class="option-label">${opt.label}</div>
                                    <div class="option-description">${opt.description}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (q.type === 'dual-text') {
                    // Enhanced Q4: Two-part input
                    optionsHTML = `
                        <div class="dual-input-container">
                            ${q.parts.map((part, partIndex) => `
                                <div class="input-section">
                                    <div class="input-label">
                                        ${part.label}
                                    </div>
                                    <div class="input-hint">${part.hint}</div>
                                    <textarea 
                                        class="text-input" 
                                        id="text-${index}-${part.id}"
                                        placeholder="${part.placeholder}"
                                        oninput="handleDualTextInput(${index}, '${part.id}', ${part.minChars}, ${part.maxChars})"
                                        maxlength="${part.maxChars}"
                                    >${answers[q.id] ? (answers[q.id][part.id] || '') : ''}</textarea>
                                    <div class="char-counter" id="counter-${index}-${part.id}">
                                        0 / ${part.minChars}-${part.maxChars} Zeichen
                                    </div>
                                    <div class="example-box">
                                        ${part.example.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (q.type === 'choice-with-text') {
                    // Q9: CTA with optional text input
                    optionsHTML = `
                        <div class="options">
                            ${q.options.map(opt => `
                                <div class="option" onclick="selectCTAOption(${index}, '${opt.value}')">
                                    <div class="option-label">${opt.label}</div>
                                    <div class="option-description">${opt.description}</div>
                                </div>
                            `).join('')}
                        </div>
                        <input 
                            type="text" 
                            class="cta-text-input" 
                            id="cta-text-${index}"
                            placeholder="${q.textPlaceholder}"
                            oninput="handleCTATextInput(${index})"
                        />
                        <div class="validation-message" id="cta-validation-${index}"></div>
                    `;
                } else if (q.type === 'text') {
                    optionsHTML = `
                        <textarea 
                            class="text-input" 
                            id="text-${index}"
                            placeholder="${q.placeholder}"
                            oninput="handleTextInput(${index})"
                        >${answers[q.id] || ''}</textarea>
                    `;
                }

                card.innerHTML = `
                    <div class="question-number">Frage ${index + 1} von ${questions.length}</div>
                    <div class="question-title">${q.question}</div>
                    ${q.subtitle ? `<div class="question-subtitle">${q.subtitle}</div>` : ''}
                    ${optionsHTML}
                `;

                container.appendChild(card);
            });
        }

        // Show specific question
        function showQuestion(index) {
            document.querySelectorAll('.question-card').forEach((card, i) => {
                card.classList.toggle('active', i === index);
            });

            document.getElementById('prevBtn').style.display = index > 0 ? 'block' : 'none';
            document.getElementById('nextBtn').textContent =
                index === questions.length - 1 ? 'Analyse starten ‚Üí' : 'Weiter ‚Üí';

            const isAnswered = answers[questions[index].id] !== undefined;
            document.getElementById('nextBtn').disabled = !isAnswered;

            // Restore selections
            if (questions[index].type === 'choice' && answers[questions[index].id]) {
                const options = document.querySelectorAll(`#question-${index} .option`);
                options.forEach(opt => {
                    const value = opt.onclick.toString().match(/'([^']+)'/)[1];
                    if (value === answers[questions[index].id]) {
                        opt.classList.add('selected');
                    }
                });
            } else if (questions[index].type === 'choice-with-text' && answers[questions[index].id]) {
                const options = document.querySelectorAll(`#question-${index} .option`);
                const savedAnswer = answers[questions[index].id];
                options.forEach(opt => {
                    const value = opt.onclick.toString().match(/'([^']+)'/)[1];
                    if (value === savedAnswer.type) {
                        opt.classList.add('selected');
                        // Show text input if needed
                        if (questions[index].showTextFor.includes(value)) {
                            const textInput = document.getElementById(`cta-text-${index}`);
                            textInput.classList.add('show');
                            textInput.value = savedAnswer.text || '';
                        }
                    }
                });
            } else if (questions[index].type === 'dual-text' && answers[questions[index].id]) {
                // Restore both text inputs for Q4
                questions[index].parts.forEach(part => {
                    const textarea = document.getElementById(`text-${index}-${part.id}`);
                    if (textarea && answers[questions[index].id][part.id]) {
                        textarea.value = answers[questions[index].id][part.id];
                        updateCharCounter(index, part.id, part.minChars, part.maxChars);
                    }
                });
            }
        }

        // Select option
        function selectOption(questionIndex, value) {
            const questionId = questions[questionIndex].id;
            answers[questionId] = value;

            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach(opt => {
                const optValue = opt.onclick.toString().match(/'([^']+)'/)[1];
                opt.classList.toggle('selected', optValue === value);
            });

            document.getElementById('nextBtn').disabled = false;
            setTimeout(() => nextQuestion(), 500);
        }

        // Handle dual text input (Q4) - WITH DEBUG
        function handleDualTextInput(questionIndex, partId, minChars, maxChars) {
            const questionId = questions[questionIndex].id;
            const textarea = document.getElementById(`text-${questionIndex}-${partId}`);
            const value = textarea.value.trim();

            console.log(`[DEBUG] Q${questionIndex} (ID: ${questionId}), Part: ${partId}, Value length: ${value.length}`);

            // Initialize answer object if needed
            if (!answers[questionId]) {
                answers[questionId] = {};
                console.log(`[DEBUG] Initialized answers[${questionId}]`);
            }

            // Store the value
            answers[questionId][partId] = value;
            console.log(`[DEBUG] Stored in answers[${questionId}][${partId}]:`, value.substring(0, 30) + '...');
            console.log(`[DEBUG] Full answers object:`, JSON.stringify(answers, null, 2));

            // Update character counter
            updateCharCounter(questionIndex, partId, minChars, maxChars);

            // Check if BOTH parts are valid
            const question = questions[questionIndex];

            let validParts = 0;
            const totalParts = question.parts.length;

            question.parts.forEach(part => {
                const partValue = answers[questionId]?.[part.id];
                const isValid = partValue && partValue.length >= part.minChars && partValue.length <= part.maxChars;

                console.log(`[DEBUG] Checking ${part.id}: length=${partValue?.length || 0}, minChars=${part.minChars}, valid=${isValid}`);

                if (isValid) {
                    validParts++;
                }
            });

            const allValid = (validParts === totalParts);

            console.log(`[DEBUG] Q${questionIndex}: ${validParts}/${totalParts} parts valid, button enabled: ${allValid}`);
            document.getElementById('nextBtn').disabled = !allValid;
        }

        // Update character counter
        function updateCharCounter(questionIndex, partId, minChars, maxChars) {
            const textarea = document.getElementById(`text-${questionIndex}-${partId}`);
            const counter = document.getElementById(`counter-${questionIndex}-${partId}`);
            const length = textarea.value.length;

            counter.textContent = `${length} / ${minChars}-${maxChars} Zeichen`;

            if (length >= minChars && length <= maxChars) {
                counter.className = 'char-counter valid';
            } else if (length > 0) {
                counter.className = 'char-counter invalid';
            } else {
                counter.className = 'char-counter';
            }
        }

        // Select CTA option (Q9)
        function selectCTAOption(questionIndex, value) {
            const questionId = questions[questionIndex].id;
            const q = questions[questionIndex];

            // Update selection UI
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach(opt => {
                const optValue = opt.onclick.toString().match(/'([^']+)'/)[1];
                opt.classList.toggle('selected', optValue === value);
            });

            // Show/hide text input based on selection
            const textInput = document.getElementById(`cta-text-${questionIndex}`);
            const validation = document.getElementById(`cta-validation-${questionIndex}`);

            if (q.showTextFor.includes(value)) {
                textInput.classList.add('show');
                textInput.focus();
                answers[questionId] = { type: value, text: textInput.value || '' };

                // Validate text length
                if (textInput.value.length >= 10) {
                    validation.className = 'validation-message success show';
                    validation.textContent = '‚úì CTA ist spezifisch genug';
                    document.getElementById('nextBtn').disabled = false;
                } else {
                    validation.className = 'validation-message error show';
                    validation.textContent = '‚ö† Bitte beschreibe die spezifische Aktion (min. 10 Zeichen)';
                    document.getElementById('nextBtn').disabled = true;
                }
            } else {
                textInput.classList.remove('show');
                validation.classList.remove('show');
                answers[questionId] = { type: value, text: '' };
                document.getElementById('nextBtn').disabled = false;

                if (value === 'unclear') {
                    // Auto-advance for "unclear" selection
                    setTimeout(() => nextQuestion(), 500);
                }
            }
        }

        // Handle CTA text input
        function handleCTATextInput(questionIndex) {
            const questionId = questions[questionIndex].id;
            const textInput = document.getElementById(`cta-text-${questionIndex}`);
            const validation = document.getElementById(`cta-validation-${questionIndex}`);
            const value = textInput.value.trim();

            if (answers[questionId]) {
                answers[questionId].text = value;
            }

            if (value.length >= 10) {
                validation.className = 'validation-message success show';
                validation.textContent = '‚úì CTA ist spezifisch genug';
                document.getElementById('nextBtn').disabled = false;
            } else {
                validation.className = 'validation-message error show';
                validation.textContent = `‚ö† Noch ${10 - value.length} Zeichen f√ºr spezifischen CTA`;
                document.getElementById('nextBtn').disabled = true;
            }
        }

        // Handle text input
        function handleTextInput(questionIndex) {
            const questionId = questions[questionIndex].id;
            const value = document.getElementById(`text-${questionIndex}`).value.trim();

            if (value.length > 10) {
                answers[questionId] = value;
                document.getElementById('nextBtn').disabled = false;
            } else {
                delete answers[questionId];
                document.getElementById('nextBtn').disabled = true;
            }
        }

        // Next question
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                showQuestion(currentQuestion);
                updateProgress();
                saveProgress();
            } else {
                finishDiagnostic();
            }
        }

        // Previous question
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                showQuestion(currentQuestion);
                updateProgress();
            }
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent =
                `${currentQuestion + 1} / ${questions.length}`;
        }

        // Save progress to database
        async function saveProgress() {
            try {
                const { data: existing, error: fetchError } = await supabaseClient
                    .from('pitch_projects')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (existing && existing.length > 0) {
                    await supabaseClient
                        .from('pitch_projects')
                        .update({
                            diagnostic_data: answers,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existing[0].id);
                } else {
                    await supabaseClient
                        .from('pitch_projects')
                        .insert({
                            user_id: currentUser.id,
                            title: 'Mein Pitch-Projekt',
                            pitch_type: answers[1] || 'unknown',
                            diagnostic_data: answers,
                            stage: answers[2] || null,
                            target_duration: answers[3] || null
                        });
                }
            } catch (error) {
                console.error('Failed to save progress:', error);
            }
        }

        // Finish diagnostic and redirect to results
        async function finishDiagnostic() {
            document.querySelectorAll('.question-card').forEach(card => card.style.display = 'none');
            document.querySelector('.progress-bar').style.display = 'none';
            document.querySelector('.buttons').style.display = 'none';
            document.getElementById('results').classList.add('active');

            await saveFinalDiagnostic();
            localStorage.setItem('diagnosticData', JSON.stringify(answers));

            console.log('‚úÖ Diagnostic completed - redirecting to enhanced results page');

            setTimeout(() => {
                window.location.href = '/diagnostic-results.html';
            }, 500);
        }

        // Save final diagnostic with completion flag
        async function saveFinalDiagnostic() {
            try {
                const { data: existing } = await supabaseClient
                    .from('pitch_projects')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (existing && existing.length > 0) {
                    await supabaseClient
                        .from('pitch_projects')
                        .update({
                            diagnostic_data: answers,
                            diagnostic_completed: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existing[0].id);
                } else {
                    await supabaseClient
                        .from('pitch_projects')
                        .insert({
                            user_id: currentUser.id,
                            title: 'Mein Pitch-Projekt',
                            pitch_type: answers[1] || 'unknown',
                            diagnostic_data: answers,
                            diagnostic_completed: true,
                            stage: answers[2] || null,
                            target_duration: answers[3] || null
                        });
                }
            } catch (error) {
                console.error('Failed to save final diagnostic:', error);
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>